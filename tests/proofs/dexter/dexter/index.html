<!DOCTYPE html>
<html lang="en">
  <head>
<meta charset="utf-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
/>
<meta
  name="description"
  content="A Michelson semantics for Tezos built using the K Framework."
/>
<meta name="keywords" content="runtime, verification, rv, k" />
<meta name="author" content="Michelson Semantics | Runtime Verification Inc" />
<meta name="robots" content="index, follow" />

<!--favicon icon-->
<!-- <link rel="icon" type="image/png" href="../../../../assets/img/favicon.ico" /> -->

<title>Michelson Semantics | Runtime Verification Inc</title>

<!-- <base href="/k/" /> -->

<!--web fonts-->
<link
  href="https://fonts.googleapis.com/css?family=Nunito:300,400,600,700,800"
  rel="stylesheet"
/>
<link
  href="https://fonts.googleapis.com/css?family=Lora:400i"
  rel="stylesheet"
/>

<link
  href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css"
  rel="stylesheet"
/>

<link href="../../../../assets/css/index.css" rel="stylesheet" />

<!--[if (gt IE 9) |!(IE)]><!-->
<!--<link rel="stylesheet" href="/assets/vendor/custom-nav/css/effects/fade-menu.css"/>-->
<!-- <link rel="stylesheet" href="../../../../assets/k/vl-nav/css/effects/slide-menu.css" /> -->
<!--<![endif]-->

  </head>

  <body>
<header
  class="navbar navbar-expand navbar-dark flex-column flex-md-row bd-navbar"
>
  <a class="logo-link" href="../../../../index.html"> Michelson Semantics </a>
  <ul class="navbar-nav ml-md-auto">
    <li class="nav-item">
      <a
        class="nav-link pl-2 pr-1 mx-1 py-3 my-n2"
        href="https://github.com/runtimeverification/michelson-semantics"
        target="_blank"
        rel="noopener"
        aria-label="GitHub"
      >
        <i class="fab fa-github"></i>
      </a>
    </li>
  </ul>
  <!--
  <a
    class="btn btn-rv-blue d-none d-lg-inline-block mb-3 mb-md-0 ml-md-3"
    href="../../../../downloads"
    >Download</a
  >
  -->
</header>


    <div class="container-fluid">
      <div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 bd-sidebar mb-3">
  <form
    role="search"
    class="bd-search d-flex align-items-center justify-content-between"
  >
    <input
      type="search"
      class="form-control"
      placeholder="Search..."
      aria-label="Search for..."
      autocomplete="false"
      id="search-box"
    />
    <button
      class="btn bd-search-docs-toggle d-md-none p-0 ml-3 collapsed"
      type="button"
      aria-label="Toggle docs navigation"
      style="font-size: 1.4rem"
    >
      <i class="fas fa-bars"></i>
    </button>
  </form>
  <nav class="collapse bd-links" aria-label="Main navigation">
    <div class="bd-toc-item">
      <a class="bd-toc-link" href="../../../../">Homepage</a>
      <a class="bd-toc-link" href="../../../../INSTALL">Install</a>
      <a class="bd-toc-link" href="../../../../USER_GUIDE">User Guide</a>
    </div>
  </nav>
</div>

        <main
          class="col-12 col-md-6 col-xl-8 py-md-3 pl-md-5 bd-content"
          role="main"
        >
          <div class="markdown-preview"><html><head></head><body><h1 id="dexter-verification">Dexter Verification</h1>
<h2 id="prologue">Prologue</h2>
<p>Our verification subject is the Michelson code corresponding to the LIGO <a href="https://gitlab.com/dexter2tz/dexter2tz" target="_blank" rel="noopener">Dexter 2 contract</a> at <a href="https://gitlab.com/dexter2tz/dexter2tz/-/tree/8a5792a56e0143042926c3ca8bff7d7068a541c3" target="_blank" rel="noopener">commit id 8a5792a5</a>.</p>
<p>The goal of this project is to produce:</p>
<ul>
<li>a series of proofs which specify that the intended behavior of each individual LIGO function is correct (which implies that the LIGO-to-Michelson compilation process is also correct in this case)</li>
<li>a series of proofs which demonstate high-level invariants over sequences of contract calls hold (e.g. it is not possible to produce a profit by exploiting rounding errors)</li>
</ul>
<p>In this project, we will model the entrypoints in Dexter contract code and extract their high-level properties.
Note that we will base our high-level descriptions of each function of the LIGO contract code, while our verification will be performed at the the level of the compiled Michelson versions.</p>
<p>We begin start our verification project by opening a new module context in which our verification will be performed.</p>
<pre class="language-k"><code><span class="token keyword">requires</span> <span class="token string">&quot;../lemmas.md&quot;</span>
<span class="token keyword">requires</span> <span class="token string">&quot;dexter-compiled.md&quot;</span>
<span class="token keyword">module</span> DEXTER<span class="token operator">-</span>VERIFICATION<span class="token operator">-</span>SYNTAX
  <span class="token keyword">imports</span> MICHELSON<span class="token operator">-</span>INTERNAL<span class="token operator">-</span>SYNTAX
</code></pre>
<pre class="language-k"><code><span class="token keyword">endmodule</span>
</code></pre>
<h2 id="dexter-lemmas">Dexter Lemmas</h2>
<pre class="language-k"><code><span class="token keyword">module</span> DEXTER<span class="token operator">-</span>LEMMAS
  <span class="token keyword">imports</span> MICHELSON
</code></pre>
<pre class="language-k"><code>  <span class="token keyword">rule</span> X <span class="token operator">/</span><span class="token keyword">Int</span> <span class="token number">1</span> <span class="token operator">=&gt;</span> X <span class="token punctuation">[</span>simplification<span class="token punctuation">]</span>
  <span class="token keyword">rule</span> X <span class="token operator">*</span><span class="token keyword">Int</span> <span class="token number">1</span> <span class="token operator">=&gt;</span> X <span class="token punctuation">[</span>simplification<span class="token punctuation">]</span>
</code></pre>
<pre class="language-k"><code><span class="token keyword">endmodule</span>
</code></pre>
<pre class="language-k"><code><span class="token keyword">module</span> DEXTER<span class="token operator">-</span>VERIFICATION
  <span class="token keyword">imports</span> DEXTER<span class="token operator">-</span>COMPILED
  <span class="token keyword">imports</span> DEXTER<span class="token operator">-</span>VERIFICATION<span class="token operator">-</span>SYNTAX
  <span class="token keyword">imports</span> DEXTER<span class="token operator">-</span>LEMMAS
</code></pre>
<h2 id="terminology-prerequisites">Terminology Prerequisites</h2>
<h3 id="entrypoints">Entrypoints</h3>
<p>Note that we are slightly abusing language in the preceding sentence because Michelson has no native notion of separate contract function entrypoints.
Instead, different entrypoints are modelled by making the global contract input parameter a disjoint union of the parameter types for each possible entrypoint, and then dispatching to different code blocks based on which entry of the disjoint union was selected.
Due to Michelon&apos;s design, this means that each entrypoint can be understood to have the following typing:</p>
<pre class="language-text"><code>entrypoint_input_type * storage_type -&gt; (operation list) * storage_type
</code></pre>
<p>where:</p>
<ol>
<li>each <code>entrypoint_input_type</code> is a member of the disjoint union which is the global contract parameter type;</li>
<li>each <code>operation</code> is a callback to be placed in a FIFO queue of callbacks that are executed once the current contract execution terminates.</li>
</ol>
<p>By abuse of notation, we identify an entrypoint&apos;s typing rule with its corresponding <code>entrypoint_input_type</code>, since the other parts of the typing rule are constant.
We may abbreviate <code>entrypoint_input_type</code> to just <code>input</code> when it is clear from context.</p>
<h3 id="storage-type">Storage Type</h3>
<p>In our proofs, we will use the following abstract representation of the Dexter contract storage state.
For simplicity, we assume the that the <code>tokenId</code> field is always present, though the verification of the FA12 version of the contract will not touch this field.</p>
<p>Calling functions produces not only storage changes but also a list of callbacks.
We serialize these to the <code>&lt;operations&gt;</code> cell for ease of writing specifications.</p>
<pre class="language-k"><code><span class="token keyword">configuration</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dexterTop</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>michelsonTop</span><span class="token punctuation">/&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>storage</span><span class="token punctuation">&gt;</span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tokenPool</span><span class="token punctuation">&gt;</span></span>               <span class="token number">0</span>                                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tokenPool</span><span class="token punctuation">&gt;</span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xtzPool</span><span class="token punctuation">&gt;</span></span>                 #Mutez<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xtzPool</span><span class="token punctuation">&gt;</span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>selfIsUpdatingTokenPool</span><span class="token punctuation">&gt;</span></span> <span class="token boolean">false</span>                                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>selfIsUpdatingTokenPool</span><span class="token punctuation">&gt;</span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>freezeBaker</span><span class="token punctuation">&gt;</span></span>             <span class="token boolean">false</span>                                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>freezeBaker</span><span class="token punctuation">&gt;</span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manager</span><span class="token punctuation">&gt;</span></span>                 #Address<span class="token punctuation">(</span><span class="token string">&quot;tz1Ke2h7sDdakHJQh8WX4Z372du1KChsksyU&quot;</span><span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manager</span><span class="token punctuation">&gt;</span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>lqtTotal</span><span class="token punctuation">&gt;</span></span>                <span class="token number">0</span>                                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>lqtTotal</span><span class="token punctuation">&gt;</span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tokenAddress</span><span class="token punctuation">&gt;</span></span>            #Address<span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>                                     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tokenAddress</span><span class="token punctuation">&gt;</span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>lqtAddress</span><span class="token punctuation">&gt;</span></span>              #Address<span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>                                     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>lqtAddress</span><span class="token punctuation">&gt;</span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tokenId</span><span class="token punctuation">&gt;</span></span>                 <span class="token number">0</span>                                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tokenId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>storage</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>operations</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>InternalList <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>operations</span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dexterTop</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<h2 id="entrypoint-summaries">Entrypoint Summaries</h2>
<p>We define our list of entrypoints below.
Each entrypoint is given a unique abstract parameter type that we use to simplify our proof structure.</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> EntryPointParams
  <span class="token keyword">syntax</span> <span class="token keyword">Bool</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> wellTypedParams<span class="token punctuation">(</span><span class="token keyword">Bool</span><span class="token punctuation">,</span> EntryPointParams<span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">,</span> functional<span class="token punctuation">]</span>
  <span class="token comment">// ---------------------------------------------------------------------------</span>
</code></pre>
<ol>
<li>
<p><a href="https://gitlab.com/dexter2tz/dexter2tz/-/blob/8a5792a56e0143042926c3ca8bff7d7068a541c3/dexter.mligo.tz" target="_blank" rel="noopener">dexter.mligo.tz</a></p>
<ol>
<li>
<p><code>add_liquidity</code>: Allows callers to &quot;mint&quot; liquidity in excahnge for tez.
Caller gains liquidity equal to <code>tez * storage.lqtTotal / storage.xtzPool</code>.</p>
<ul>
<li>
<p>Input:</p>
<pre class="language-k"><code><span class="token keyword">syntax</span> EntryPointParams   <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> AddLiquidityParams
<span class="token keyword">syntax</span> AddLiquidityParams <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> AddLiquidity<span class="token punctuation">(</span>owner              <span class="token punctuation">:</span> Address<span class="token punctuation">,</span>
                                           minLqtMinted       <span class="token punctuation">:</span> <span class="token keyword">Int</span><span class="token punctuation">,</span>
                                           maxTokensDeposited <span class="token punctuation">:</span> <span class="token keyword">Int</span><span class="token punctuation">,</span>
                                           deadline           <span class="token punctuation">:</span> Timestamp<span class="token punctuation">)</span>
<span class="token keyword">rule</span> wellTypedParams<span class="token punctuation">(</span>_IsFA2<span class="token punctuation">,</span> AddLiquidity<span class="token punctuation">(</span>_Owner<span class="token punctuation">,</span>
                                           MinLqtMinted<span class="token punctuation">,</span>
                                           MaxTokensDeposited<span class="token punctuation">,</span>
                                           Deadline<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token operator">=&gt;</span>         MinLqtMinted       <span class="token operator">&gt;=</span><span class="token keyword">Int</span> <span class="token number">0</span>
        andBool MaxTokensDeposited <span class="token operator">&gt;=</span><span class="token keyword">Int</span> <span class="token number">0</span>
        andBool #IsLegalTimestamp<span class="token punctuation">(</span>Deadline<span class="token punctuation">)</span>
     <span class="token punctuation">[</span>simplification<span class="token punctuation">]</span>
</code></pre>
</li>
</ul>
</li>
<li>
<p><code>remove_liquidity</code></p>
<ul>
<li>
<p>Input:</p>
<pre class="language-k"><code><span class="token keyword">syntax</span> EntryPointParams      <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> RemoveLiquidityParams
<span class="token keyword">syntax</span> RemoveLiquidityParams <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> RemoveLiquidity<span class="token punctuation">(</span>to                 <span class="token punctuation">:</span> Address<span class="token punctuation">,</span>
                                                 lqtBurned          <span class="token punctuation">:</span> <span class="token keyword">Int</span><span class="token punctuation">,</span>
                                                 minXtzWithdrawn    <span class="token punctuation">:</span> Mutez<span class="token punctuation">,</span>
                                                 minTokensWithdrawn <span class="token punctuation">:</span> <span class="token keyword">Int</span><span class="token punctuation">,</span>
                                                 deadline           <span class="token punctuation">:</span> Timestamp<span class="token punctuation">)</span>
<span class="token keyword">rule</span> wellTypedParams<span class="token punctuation">(</span>_IsFA2<span class="token punctuation">,</span> RemoveLiquidity<span class="token punctuation">(</span>_To<span class="token punctuation">,</span>
                                              LqtBurned<span class="token punctuation">,</span>
                                              MinXtzWithdrawn<span class="token punctuation">,</span>
                                              MinTokensWithdrawn<span class="token punctuation">,</span>
                                              Deadline<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token operator">=&gt;</span>         LqtBurned <span class="token operator">&gt;=</span><span class="token keyword">Int</span> <span class="token number">0</span>
         andBool #IsLegalMutezValue<span class="token punctuation">(</span>MinXtzWithdrawn<span class="token punctuation">)</span>
         andBool MinTokensWithdrawn <span class="token operator">&gt;=</span><span class="token keyword">Int</span> <span class="token number">0</span>
         andBool #IsLegalTimestamp<span class="token punctuation">(</span>Deadline<span class="token punctuation">)</span>
         <span class="token punctuation">[</span>simplification<span class="token punctuation">]</span>
</code></pre>
</li>
<li>
<p>Output:</p>
<pre class="language-text"><code>( [ Transfer_tokens ( lqtBurned, txn.sender )                0mutez         storage.lqtAddress   %mintOrBurn
    Transfer_tokens ( self.address, to_, $tokens_withdrawn ) 0mutez         storage.tokenAddress %transfer
    Transfer_tokens ()                                       $xtz_withdrawn _to
  ], { storage with tokenPool -= $tokens_withdrawn,
                    xtzPool   -= $xtz_withdrawn,
                    lqtTotal  -= lqtBurned} )
</code></pre>
<p>where <code>$xtz_withdrawn    = storage.xtzPool *    (lqtBurned / storage.lqtTotal)</code>
and <code>$tokens_withdrawn = storage.tokenPool *  (lqtBurned / storage.lqtTotal)</code></p>
</li>
</ul>
</li>
<li>
<p><code>set_baker</code></p>
<ul>
<li>
<p>Input:</p>
<pre class="language-k"><code><span class="token keyword">syntax</span> EntryPointParams <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> SetBakerParams
<span class="token keyword">syntax</span> SetBakerParams   <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> SetBaker<span class="token punctuation">(</span>baker       <span class="token punctuation">:</span> OptionData<span class="token punctuation">,</span>
                                     freezeBaker <span class="token punctuation">:</span> <span class="token keyword">Bool</span><span class="token punctuation">)</span>
<span class="token keyword">rule</span> wellTypedParams<span class="token punctuation">(</span>_IsFA2<span class="token punctuation">,</span> SetBaker<span class="token punctuation">(</span>None<span class="token punctuation">,</span>        _<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
<span class="token keyword">rule</span> wellTypedParams<span class="token punctuation">(</span>_IsFA2<span class="token punctuation">,</span> SetBaker<span class="token punctuation">(</span>Some D<span class="token punctuation">:</span>Data<span class="token punctuation">,</span> _<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> isKeyHash<span class="token punctuation">(</span>D<span class="token punctuation">)</span> <span class="token punctuation">[</span>simplification<span class="token punctuation">]</span>
</code></pre>
</li>
<li>
<p>Output:</p>
<pre class="language-text"><code>( [ set_delegate(baker) ], { storage with freezeBaker = freezeBaker } )
</code></pre>
</li>
</ul>
</li>
<li>
<p><code>set_manager</code></p>
<ul>
<li>
<p>Input:</p>
<pre class="language-k"><code><span class="token keyword">syntax</span> EntryPointParams <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> SetManagerParams
<span class="token keyword">syntax</span> SetManagerParams <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> SetManager<span class="token punctuation">(</span>newManager <span class="token punctuation">:</span> Address<span class="token punctuation">)</span>
<span class="token keyword">rule</span> wellTypedParams<span class="token punctuation">(</span>_IsFA2<span class="token punctuation">,</span> _<span class="token punctuation">:</span>SetManagerParams<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span> <span class="token punctuation">[</span>simplification<span class="token punctuation">]</span>
</code></pre>
</li>
<li>
<p>Output:</p>
<pre class="language-text"><code>( [], { storage with manager = new_manager } )
</code></pre>
</li>
</ul>
</li>
<li>
<p><code>set_lqt_address</code></p>
<ul>
<li>
<p>Input:</p>
<pre class="language-k"><code><span class="token keyword">syntax</span> EntryPointParams    <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> SetLQTAddressParams
<span class="token keyword">syntax</span> SetLQTAddressParams <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> SetLQTAddress<span class="token punctuation">(</span>lqtAddress <span class="token punctuation">:</span> Address<span class="token punctuation">)</span>
<span class="token keyword">rule</span> wellTypedParams<span class="token punctuation">(</span>_IsFA2<span class="token punctuation">,</span> _<span class="token punctuation">:</span>SetLQTAddressParams<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span> <span class="token punctuation">[</span>simplification<span class="token punctuation">]</span>
</code></pre>
</li>
<li>
<p>Output:</p>
<pre class="language-text"><code>( [], { storage with lqtAddress = lqtAddress } )
</code></pre>
</li>
</ul>
</li>
<li>
<p><code>default_</code></p>
<ul>
<li>
<p>Input:</p>
<pre class="language-k"><code><span class="token keyword">syntax</span> EntryPointParams <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> DefaultParams
<span class="token keyword">syntax</span> DefaultParams    <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;Default&quot;</span>
<span class="token keyword">rule</span> wellTypedParams<span class="token punctuation">(</span>_IsFA2<span class="token punctuation">,</span> Default<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span> <span class="token punctuation">[</span>simplification<span class="token punctuation">]</span>
</code></pre>
</li>
<li>
<p>Output:</p>
<pre class="language-text"><code>( [], { storage with xtzPool += txn.amount } )
</code></pre>
</li>
</ul>
</li>
<li>
<p><code>update_token_pool</code></p>
<ul>
<li>
<p>Input:</p>
<pre class="language-k"><code><span class="token keyword">syntax</span> EntryPointParams      <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> UpdateTokenPoolParams
<span class="token keyword">syntax</span> UpdateTokenPoolParams <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;UpdateTokenPool&quot;</span>
<span class="token keyword">rule</span> wellTypedParams<span class="token punctuation">(</span>_IsFA2<span class="token punctuation">,</span> UpdateTokenPool<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span> <span class="token punctuation">[</span>simplification<span class="token punctuation">]</span>
</code></pre>
</li>
<li>
<p>Output:</p>
<pre class="language-text"><code>( [ Transfer_tokens Params 0xtz storage.tokenAddress ], { storage with selfIsUpdatingTokenPool = true } )
</code></pre>
<p>where, in version FA2, <code>Params = Pair (self.address, storage.tokenId)</code> and in version FA12, <code>Params = self.address</code></p>
</li>
</ul>
</li>
<li>
<p><code>update_token_pool_internal</code></p>
<ul>
<li>
<p>Input:</p>
<pre class="language-k"><code><span class="token keyword">syntax</span> EntryPointParams                  <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> UpdateTokenPoolInternalParams
<span class="token keyword">syntax</span> UpdateTokenPoolInternalParams     <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> UpdateTokenPoolInternalFA12Params
                                           <span class="token operator">|</span> UpdateTokenPoolInternalFA2Params
<span class="token keyword">syntax</span> UpdateTokenPoolInternalFA12Params <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> UpdateTokenPoolInternalFA12<span class="token punctuation">(</span>balance         <span class="token punctuation">:</span> <span class="token keyword">Int</span><span class="token punctuation">)</span>
<span class="token keyword">syntax</span> UpdateTokenPoolInternalFA2Params  <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> UpdateTokenPoolInternalFA2 <span class="token punctuation">(</span>balanceOfResult <span class="token punctuation">:</span> InternalList<span class="token punctuation">)</span>

<span class="token keyword">rule</span> wellTypedParams<span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> UpdateTokenPoolInternalFA12<span class="token punctuation">(</span>Balance<span class="token punctuation">)</span><span class="token punctuation">)</span>         <span class="token operator">=&gt;</span> Balance <span class="token operator">&gt;=</span><span class="token keyword">Int</span> <span class="token number">0</span>                       <span class="token punctuation">[</span>simplification<span class="token punctuation">]</span>
<span class="token keyword">rule</span> wellTypedParams<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>  UpdateTokenPoolInternalFA2 <span class="token punctuation">(</span>BalanceOfResult<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> validBalanceOfParams<span class="token punctuation">(</span>BalanceOfResult<span class="token punctuation">)</span> <span class="token punctuation">[</span>simplification<span class="token punctuation">]</span>

<span class="token keyword">syntax</span> <span class="token keyword">Bool</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> validBalanceOfParams<span class="token punctuation">(</span>InternalList<span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">,</span> functional<span class="token punctuation">]</span>
              <span class="token operator">|</span> validBalanceOfEntry<span class="token punctuation">(</span>Data<span class="token punctuation">)</span>          <span class="token punctuation">[</span>function<span class="token punctuation">,</span> functional<span class="token punctuation">]</span>
<span class="token comment">// ----------------------------------------------------------</span>
<span class="token keyword">rule</span> validBalanceOfParams<span class="token punctuation">(</span><span class="token punctuation">.</span>InternalList<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
<span class="token keyword">rule</span> validBalanceOfParams<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">|</span> D<span class="token punctuation">:</span>Data <span class="token operator">|</span><span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token punctuation">;</span> IL<span class="token punctuation">:</span>InternalList<span class="token punctuation">)</span>
  <span class="token operator">=&gt;</span> validBalanceOfEntry<span class="token punctuation">(</span>D<span class="token punctuation">)</span> andBool validBalanceOfParams<span class="token punctuation">(</span>IL<span class="token punctuation">)</span>

<span class="token keyword">rule</span> validBalanceOfEntry<span class="token punctuation">(</span>Pair <span class="token punctuation">(</span>Pair _<span class="token punctuation">:</span>Address N1<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">)</span> N2<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">)</span>
  <span class="token operator">=&gt;</span> N1 <span class="token operator">&gt;=</span><span class="token keyword">Int</span> <span class="token number">0</span> andBool N2 <span class="token operator">&gt;=</span><span class="token keyword">Int</span> <span class="token number">0</span>
<span class="token keyword">rule</span> validBalanceOfEntry<span class="token punctuation">(</span>_<span class="token punctuation">:</span>Data<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">false</span> <span class="token punctuation">[</span>owise<span class="token punctuation">]</span>
</code></pre>
</li>
<li>
<p>Output:</p>
<pre class="language-text"><code>( [], { storage with tokenPool = $tokenPool selfIsUpdatingTokenPool = false } )
</code></pre>
<p>where, in version FA2, <code>$tokenPool</code> is the second projection of the tuple at the head of the input list;
in version FA12, <code>$tokenPool</code> is equal to the input.</p>
</li>
</ul>
</li>
<li>
<p><code>xtz_to_token</code></p>
<ul>
<li>Input:</li>
</ul>
<pre class="language-k"><code><span class="token keyword">syntax</span> EntryPointParams <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> XtzToTokenParams
<span class="token keyword">syntax</span> XtzToTokenParams <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> XtzToToken<span class="token punctuation">(</span>to              <span class="token punctuation">:</span> Address<span class="token punctuation">,</span>
                                       minTokensBought <span class="token punctuation">:</span> <span class="token keyword">Int</span><span class="token punctuation">,</span>
                                       deadline        <span class="token punctuation">:</span> Timestamp<span class="token punctuation">)</span>
<span class="token keyword">rule</span> wellTypedParams<span class="token punctuation">(</span>_IsFA2<span class="token punctuation">,</span> XtzToToken<span class="token punctuation">(</span>_To<span class="token punctuation">,</span> MinTokensBought<span class="token punctuation">,</span> Deadline<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token operator">=&gt;</span> MinTokensBought <span class="token operator">&gt;=</span><span class="token keyword">Int</span> <span class="token number">0</span> andBool #IsLegalTimestamp<span class="token punctuation">(</span>Deadline<span class="token punctuation">)</span>
     <span class="token punctuation">[</span>simplification<span class="token punctuation">]</span>
</code></pre>
<ul>
<li>
<p>Output:</p>
<pre class="language-text"><code>( [ Transfer_tokens ( self.address, to_, #TokensBought ) 0xtz storage.tokenAddress %transfer ],
  { storage with xtzPool += txn.amount ; tokenPool -= #TokensBought } )
</code></pre>
<p>where <code>#TokensBought</code> is the current total of tokens exchanged from <code>txn.amount</code> defined by
the macro given below.</p>
</li>
</ul>
</li>
<li>
<p><code>token_to_xtz</code></p>
<ul>
<li>Input:</li>
</ul>
<pre class="language-k"><code><span class="token keyword">syntax</span> EntryPointParams <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> TokenToXtzParams
<span class="token keyword">syntax</span> TokenToXtzParams <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> TokenToXtz<span class="token punctuation">(</span>to           <span class="token punctuation">:</span> Address<span class="token punctuation">,</span>
                                       tokensSold   <span class="token punctuation">:</span> <span class="token keyword">Int</span><span class="token punctuation">,</span>
                                       minXtzBought <span class="token punctuation">:</span> Mutez<span class="token punctuation">,</span>
                                       deadline     <span class="token punctuation">:</span> Timestamp<span class="token punctuation">)</span>
<span class="token keyword">rule</span> wellTypedParams<span class="token punctuation">(</span>_IsFA2<span class="token punctuation">,</span> TokenToXtz<span class="token punctuation">(</span>_To<span class="token punctuation">,</span> TokensSold<span class="token punctuation">,</span> MinXtzBought<span class="token punctuation">,</span> Deadline<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token operator">=&gt;</span>         TokensSold <span class="token operator">&gt;=</span><span class="token keyword">Int</span> <span class="token number">0</span>
     andBool #IsLegalMutezValue<span class="token punctuation">(</span>MinXtzBought<span class="token punctuation">)</span>
     andBool #IsLegalTimestamp<span class="token punctuation">(</span>Deadline<span class="token punctuation">)</span>
     <span class="token punctuation">[</span>simplification<span class="token punctuation">]</span>
</code></pre>
<ul>
<li>
<p>Output:</p>
<pre class="language-text"><code>( [ Transfer_tokens ( txn.sender, self.address, tokensSold ) 0xtz self.tokenAddress %transfer ]
  [ Transfer_tokens () #XtzBought _to ],
  { storage with xtzPool -= #XtzBought ; tokenPool += tokensSold } )
</code></pre>
<p>where <code>#XtzBought</code> is the current total of xtz exchanged from <code>tokensSold</code> by the formula
defined by the macro below.</p>
</li>
</ul>
</li>
<li>
<p><code>token_to_token</code></p>
<ul>
<li>Input:</li>
</ul>
<pre class="language-k"><code><span class="token keyword">syntax</span> EntryPointParams   <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> TokenToTokenParams
<span class="token keyword">syntax</span> TokenToTokenParams <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> TokenToToken<span class="token punctuation">(</span>outputDexterContract <span class="token punctuation">:</span> Address<span class="token punctuation">,</span>
                                           minTokensBought      <span class="token punctuation">:</span> <span class="token keyword">Int</span><span class="token punctuation">,</span>
                                           to                   <span class="token punctuation">:</span> Address<span class="token punctuation">,</span>
                                           tokensSold           <span class="token punctuation">:</span> <span class="token keyword">Int</span><span class="token punctuation">,</span>
                                           deadline             <span class="token punctuation">:</span> Timestamp<span class="token punctuation">)</span>
<span class="token keyword">rule</span> wellTypedParams<span class="token punctuation">(</span>_IsFA2<span class="token punctuation">,</span> TokenToToken<span class="token punctuation">(</span>_OutputDexterContract<span class="token punctuation">,</span>
                                           MinTokensBought<span class="token punctuation">,</span>
                                          _To<span class="token punctuation">,</span>
                                           TokensSold<span class="token punctuation">,</span>
                                           Deadline<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token operator">=&gt;</span>         MinTokensBought <span class="token operator">&gt;=</span><span class="token keyword">Int</span> <span class="token number">0</span>
     andBool TokensSold <span class="token operator">&gt;=</span><span class="token keyword">Int</span> <span class="token number">0</span>
     andBool #IsLegalTimestamp<span class="token punctuation">(</span>Deadline<span class="token punctuation">)</span>
     <span class="token punctuation">[</span>simplification<span class="token punctuation">]</span>
</code></pre>
<ul>
<li>
<p>Output:</p>
<pre class="language-text"><code>( [ Transfer_tokens ( txn.sender, self.address, tokensSold ) 0xtz self.tokenAddress %transfer     ]
  [ Transfer_tokens { to_, minTokensBought, deadline } #XtzBought outputDexterContract %xtz_to_token ],
  { storage with xtzPool -= #XtzBought ; tokenPool += tokensSold } )
</code></pre>
<p>where <code>#XtzBought</code> is the current total of xtz exchanged from <code>TokensSold</code> by the formula</p>
</li>
</ul>
</li>
</ol>
</li>
<li>
<p><a href="https://gitlab.com/dexter2tz/dexter2tz/-/blob/8a5792a56e0143042926c3ca8bff7d7068a541c3/lqt_fa12.mligo.tz" target="_blank" rel="noopener">lqt_fa12.mligo.tz</a></p>
<p>Note that, in this case, we do not need to verify this implementation in particular; it is sufficient that we can model the behavior of an arbitrary contract which conforms to the FA1.2 standard.
Such a contract will have the following entry points:</p>
<ol>
<li><code>transfer</code></li>
<li><code>approve</code></li>
<li><code>mintOrBurn</code></li>
<li><code>getAllowance</code></li>
<li><code>getBalance</code></li>
<li><code>getTotalSupply</code></li>
</ol>
</li>
</ol>
<p>As reference materials for understanding the contract intent, we will consult:</p>
<ol>
<li>The <a href="https://gitlab.com/dexter2tz/dexter2tz/-/blob/master/origination.sh" target="_blank" rel="noopener">Dexter 2 origination script</a></li>
<li>The <a href="https://ligolang.org/docs/intro/introduction" target="_blank" rel="noopener">LIGO documentation</a></li>
<li>The <a href="http://tezos.gitlab.io/008/michelson.html" target="_blank" rel="noopener">Michelson documentation</a></li>
<li>The <a href="https://gitlab.com/tzip/tzip/blob/master/proposals/tzip-7/tzip-7.md" target="_blank" rel="noopener">FA 1.2 standard</a></li>
<li>The <a href="https://gitlab.com/tzip/tzip/-/blob/master/proposals/tzip-12/tzip-12.md" target="_blank" rel="noopener">FA 2 standard</a></li>
</ol>
<h2 id="state-abstraction">State Abstraction</h2>
<p>We use a few helper routines to convert between our abstract and concrete proof state.
We first define functions which build our parameter and our storage types.</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> TypeName <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #DexterParamType<span class="token punctuation">(</span><span class="token keyword">Bool</span><span class="token punctuation">)</span>                <span class="token punctuation">[</span>function<span class="token punctuation">,</span> functional<span class="token punctuation">]</span>
                    <span class="token operator">|</span> #DexterVersionSpecificParamType<span class="token punctuation">(</span><span class="token keyword">Bool</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">,</span> functional<span class="token punctuation">]</span>
  <span class="token comment">// -----------------------------------------------------------------------------</span>
  <span class="token keyword">rule</span> #DexterParamType<span class="token punctuation">(</span>IsFA2<span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>or
          <span class="token punctuation">(</span>or
             <span class="token punctuation">(</span>or
                <span class="token punctuation">(</span>or <span class="token punctuation">(</span>pair address                        <span class="token comment">// addLiquidity</span>
                       pair nat
                         pair nat timestamp<span class="token punctuation">)</span>
                    unit<span class="token punctuation">)</span>                                <span class="token comment">// default</span>
                <span class="token punctuation">(</span>or <span class="token punctuation">(</span>pair address                        <span class="token comment">// removeLiquidity</span>
                       pair nat
                         pair mutez
                           pair nat timestamp<span class="token punctuation">)</span>
                    <span class="token punctuation">(</span>pair option key_hash bool<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment">// setBaker</span>
             <span class="token punctuation">(</span>or
                <span class="token punctuation">(</span>or address                              <span class="token comment">// setLqtAddress</span>
                    address<span class="token punctuation">)</span>                             <span class="token comment">// setManager</span>
                <span class="token punctuation">(</span>or <span class="token punctuation">(</span>pair address                        <span class="token comment">// tokenToToken</span>
                       pair nat
                         pair address
                           pair nat timestamp<span class="token punctuation">)</span>
                    <span class="token punctuation">(</span>pair address                        <span class="token comment">// tokenToXtz</span>
                       pair nat
                         pair mutez timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">(</span>or
             <span class="token punctuation">(</span>or unit                                    <span class="token comment">// updateTokenPool</span>
                 #DexterVersionSpecificParamType<span class="token punctuation">(</span>IsFA2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// updateTokenPoolInternal</span>
             <span class="token punctuation">(</span>pair address                               <span class="token comment">// xtzToToken</span>
                pair nat timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">rule</span> #DexterVersionSpecificParamType<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>  <span class="token operator">=&gt;</span> list pair pair address nat nat
  <span class="token keyword">rule</span> #DexterVersionSpecificParamType<span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> nat

  <span class="token keyword">syntax</span> TypeName <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #DexterStorageType<span class="token punctuation">(</span><span class="token keyword">Bool</span><span class="token punctuation">)</span>                <span class="token punctuation">[</span>function<span class="token punctuation">,</span> functional<span class="token punctuation">]</span>
                    <span class="token operator">|</span> #DexterVersionSpecificStorageType<span class="token punctuation">(</span><span class="token keyword">Bool</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">,</span> functional<span class="token punctuation">]</span>
  <span class="token comment">// -------------------------------------------------------------------------------</span>
  <span class="token keyword">rule</span> #DexterStorageType<span class="token punctuation">(</span>IsFA2<span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> pair nat
         pair mutez
           pair nat
             pair bool
               pair bool
                 pair address
                   pair address
                     #DexterVersionSpecificStorageType<span class="token punctuation">(</span>IsFA2<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> #DexterVersionSpecificStorageType<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>  <span class="token operator">=&gt;</span> pair nat address
  <span class="token keyword">rule</span> #DexterVersionSpecificStorageType<span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> address
</code></pre>
<p>We also define a functions that serialize and deserialize our abstract parameters and state.</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> Data <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #LoadDexterParams<span class="token punctuation">(</span><span class="token keyword">Bool</span><span class="token punctuation">,</span> EntryPointParams<span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">,</span> functional<span class="token punctuation">]</span>
  <span class="token comment">// -----------------------------------------------------------------------------</span>
  <span class="token keyword">rule</span> #LoadDexterParams<span class="token punctuation">(</span>_IsFA2<span class="token punctuation">,</span> AddLiquidity<span class="token punctuation">(</span>Owner<span class="token punctuation">,</span> MinLqtMinted<span class="token punctuation">,</span> MaxTokensDeposited<span class="token punctuation">,</span> Deadline<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> Left Left Left Left Pair Owner Pair MinLqtMinted Pair MaxTokensDeposited Deadline

  <span class="token keyword">rule</span> #LoadDexterParams<span class="token punctuation">(</span>_IsFA2<span class="token punctuation">,</span> Default<span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> Left Left Left Right Unit

  <span class="token keyword">rule</span> #LoadDexterParams<span class="token punctuation">(</span>_IsFA2<span class="token punctuation">,</span> RemoveLiquidity<span class="token punctuation">(</span>To<span class="token punctuation">,</span> LqtBurned<span class="token punctuation">,</span> MinXtzWithdrawn<span class="token punctuation">,</span> MinTokensWithdrawn<span class="token punctuation">,</span> Deadline<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> Left Left Right Left Pair To Pair LqtBurned Pair MinXtzWithdrawn Pair MinTokensWithdrawn Deadline

  <span class="token keyword">rule</span> #LoadDexterParams<span class="token punctuation">(</span>_IsFA2<span class="token punctuation">,</span> SetBaker<span class="token punctuation">(</span>Baker<span class="token punctuation">,</span> FreezeBaker<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> Left Left Right Right Pair Baker FreezeBaker

  <span class="token keyword">rule</span> #LoadDexterParams<span class="token punctuation">(</span>_IsFA2<span class="token punctuation">,</span> SetLQTAddress<span class="token punctuation">(</span>LqtAddress<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> Left Right Left Left LqtAddress

  <span class="token keyword">rule</span> #LoadDexterParams<span class="token punctuation">(</span>_IsFA2<span class="token punctuation">,</span> SetManager<span class="token punctuation">(</span>NewManager<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> Left Right Left Right NewManager

  <span class="token keyword">rule</span> #LoadDexterParams<span class="token punctuation">(</span>_IsFA2<span class="token punctuation">,</span> TokenToToken<span class="token punctuation">(</span>OutputDexterContract<span class="token punctuation">,</span> MinTokensBought<span class="token punctuation">,</span> To<span class="token punctuation">,</span> TokensSold<span class="token punctuation">,</span> Deadline<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> Left Right Right Left Pair OutputDexterContract Pair MinTokensBought Pair To Pair TokensSold Deadline

  <span class="token keyword">rule</span> #LoadDexterParams<span class="token punctuation">(</span>_IsFA2<span class="token punctuation">,</span> TokenToXtz<span class="token punctuation">(</span>To<span class="token punctuation">,</span> TokensSold<span class="token punctuation">,</span> MinXtzBought<span class="token punctuation">,</span> Deadline<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> Left Right Right Right Pair To Pair TokensSold Pair MinXtzBought Deadline

  <span class="token keyword">rule</span> #LoadDexterParams<span class="token punctuation">(</span>_IsFA2<span class="token punctuation">,</span> UpdateTokenPool<span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> Right Left Left Unit

  <span class="token keyword">rule</span> #LoadDexterParams<span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span>  UpdateTokenPoolInternalFA12<span class="token punctuation">(</span>Balance<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> Right Left Right Balance

  <span class="token keyword">rule</span> #LoadDexterParams<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>   UpdateTokenPoolInternalFA2<span class="token punctuation">(</span>BalanceOfResult<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> Right Left Right BalanceOfResult

  <span class="token keyword">rule</span> #LoadDexterParams<span class="token punctuation">(</span>_IsFA2<span class="token punctuation">,</span> XtzToToken<span class="token punctuation">(</span>To<span class="token punctuation">,</span> MinTokensBought<span class="token punctuation">,</span> Deadline<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> Right Right Pair To Pair MinTokensBought Deadline

  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #loadDexterState<span class="token punctuation">(</span><span class="token keyword">Bool</span><span class="token punctuation">,</span> EntryPointParams<span class="token punctuation">)</span>
  <span class="token comment">// ------------------------------------------------------</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #loadDexterState<span class="token punctuation">(</span>IsFA2<span class="token punctuation">,</span> Params<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>Stack
            <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> pair #DexterParamType<span class="token punctuation">(</span>IsFA2<span class="token punctuation">)</span> #DexterStorageType<span class="token punctuation">(</span>IsFA2<span class="token punctuation">)</span>
                 Pair #LoadDexterParams<span class="token punctuation">(</span>IsFA2<span class="token punctuation">,</span> Params<span class="token punctuation">)</span>
                   Pair TokenPool
                     Pair XTZPool
                       Pair LQTTotal
                         Pair IsUpdatingTokenPool
                           Pair IsBakerFrozen
                             Pair Manager
                               Pair TokenAddress
                                 #if IsFA2
                                   #then Pair TokenId LQTAddress
                                   #else LQTAddress
                                 #fi <span class="token punctuation">]</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tokenPool</span><span class="token punctuation">&gt;</span></span>               TokenPool           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tokenPool</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xtzPool</span><span class="token punctuation">&gt;</span></span>                 XTZPool             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xtzPool</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>lqtTotal</span><span class="token punctuation">&gt;</span></span>                LQTTotal            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>lqtTotal</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>selfIsUpdatingTokenPool</span><span class="token punctuation">&gt;</span></span> IsUpdatingTokenPool <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>selfIsUpdatingTokenPool</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>freezeBaker</span><span class="token punctuation">&gt;</span></span>             IsBakerFrozen       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>freezeBaker</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manager</span><span class="token punctuation">&gt;</span></span>                 Manager             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manager</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tokenAddress</span><span class="token punctuation">&gt;</span></span>            TokenAddress        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tokenAddress</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tokenId</span><span class="token punctuation">&gt;</span></span>                 TokenId             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tokenId</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>lqtAddress</span><span class="token punctuation">&gt;</span></span>              LQTAddress          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>lqtAddress</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #storeDexterState<span class="token punctuation">(</span><span class="token keyword">Bool</span><span class="token punctuation">)</span>
                 <span class="token operator">|</span> #storeDexterState<span class="token punctuation">(</span><span class="token keyword">Bool</span><span class="token punctuation">,</span> Data<span class="token punctuation">)</span>
  <span class="token comment">// -------------------------------------------</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #storeDexterState<span class="token punctuation">(</span>IsFA2<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> #storeDexterState<span class="token punctuation">(</span>IsFA2<span class="token punctuation">,</span> VersionSpecificData<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> pair list operation StorageType<span class="token punctuation">:</span>TypeName
                 Pair OpList
                   Pair TokenPool
                     Pair XTZPool
                       Pair LQTTotal
                         Pair IsUpdatingTokenPool
                           Pair IsBakerFrozen
                             Pair Manager
                               Pair TokenContract
                                 VersionSpecificData <span class="token punctuation">]</span>
            <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>Stack
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tokenPool</span><span class="token punctuation">&gt;</span></span>               _ <span class="token operator">=&gt;</span> TokenPool           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tokenPool</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xtzPool</span><span class="token punctuation">&gt;</span></span>                 _ <span class="token operator">=&gt;</span> XTZPool             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xtzPool</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>lqtTotal</span><span class="token punctuation">&gt;</span></span>                _ <span class="token operator">=&gt;</span> LQTTotal            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>lqtTotal</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>selfIsUpdatingTokenPool</span><span class="token punctuation">&gt;</span></span> _ <span class="token operator">=&gt;</span> IsUpdatingTokenPool <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>selfIsUpdatingTokenPool</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>freezeBaker</span><span class="token punctuation">&gt;</span></span>             _ <span class="token operator">=&gt;</span> IsBakerFrozen       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>freezeBaker</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manager</span><span class="token punctuation">&gt;</span></span>                 _ <span class="token operator">=&gt;</span> Manager             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manager</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tokenAddress</span><span class="token punctuation">&gt;</span></span>            _ <span class="token operator">=&gt;</span> TokenContract       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tokenAddress</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>operations</span><span class="token punctuation">&gt;</span></span>              _ <span class="token operator">=&gt;</span> OpList              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>operations</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> StorageType <span class="token operator">==</span>K #DexterStorageType<span class="token punctuation">(</span>IsFA2<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #storeDexterState<span class="token punctuation">(</span>IsFA2<span class="token punctuation">,</span> Pair TokenId LQTContract<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tokenId</span><span class="token punctuation">&gt;</span></span>    _ <span class="token operator">=&gt;</span> TokenId     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tokenId</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>lqtAddress</span><span class="token punctuation">&gt;</span></span> _ <span class="token operator">=&gt;</span> LQTContract <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>lqtAddress</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> IsFA2

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #storeDexterState<span class="token punctuation">(</span>IsFA2<span class="token punctuation">,</span> LQTContract<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>lqtAddress</span><span class="token punctuation">&gt;</span></span> _ <span class="token operator">=&gt;</span> LQTContract <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>lqtAddress</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> notBool IsFA2
</code></pre>
<p>If the contract execution fails, storage is not updated.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> Aborted<span class="token punctuation">(</span>_<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> <span class="token punctuation">(</span>#storeDexterState<span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<h2 id="proof-helper-functions">Proof Helper Functions</h2>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> Data <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #UpdateTokenPoolTransferFrom<span class="token punctuation">(</span><span class="token keyword">Bool</span><span class="token punctuation">,</span> Address<span class="token punctuation">,</span> <span class="token keyword">Int</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">,</span> functional<span class="token punctuation">]</span>
 <span class="token comment">// -------------------------------------------------------------------------------------</span>
  <span class="token keyword">rule</span> #UpdateTokenPoolTransferFrom<span class="token punctuation">(</span>IsFA2<span class="token punctuation">,</span> SelfAddress<span class="token punctuation">,</span> _TokenId<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>         SelfAddress                             <span class="token keyword">requires</span> notBool IsFA2 <span class="token punctuation">[</span>simplification<span class="token punctuation">]</span>
  <span class="token keyword">rule</span> #UpdateTokenPoolTransferFrom<span class="token punctuation">(</span>IsFA2<span class="token punctuation">,</span> SelfAddress<span class="token punctuation">,</span>  TokenId<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token operator">|</span> Pair SelfAddress TokenId <span class="token operator">|</span><span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token punctuation">.</span>InternalList <span class="token keyword">requires</span>         IsFA2 <span class="token punctuation">[</span>simplification<span class="token punctuation">]</span>

  <span class="token keyword">syntax</span> Type <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #TokenContractType<span class="token punctuation">(</span><span class="token keyword">Bool</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">,</span> functional<span class="token punctuation">]</span>
 <span class="token comment">// -------------------------------------------------------------</span>
  <span class="token keyword">rule</span> #TokenContractType<span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> #Type<span class="token punctuation">(</span>pair address                   <span class="token punctuation">(</span>contract #DexterVersionSpecificParamType<span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>simplification<span class="token punctuation">]</span>
  <span class="token keyword">rule</span> #TokenContractType<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>  <span class="token operator">=&gt;</span> #Type<span class="token punctuation">(</span>pair <span class="token punctuation">(</span>list <span class="token punctuation">(</span>pair address nat<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>contract #DexterVersionSpecificParamType<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">[</span>simplification<span class="token punctuation">]</span>

  <span class="token keyword">syntax</span> Type <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #TokenTransferType<span class="token punctuation">(</span><span class="token keyword">Bool</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">,</span> functional<span class="token punctuation">]</span>
 <span class="token comment">// -------------------------------------------------------------</span>
  <span class="token keyword">rule</span> #TokenTransferType<span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> #Type<span class="token punctuation">(</span>pair address pair address nat<span class="token punctuation">)</span> <span class="token punctuation">[</span>simplification<span class="token punctuation">]</span>
  <span class="token keyword">rule</span> #TokenTransferType<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>  <span class="token operator">=&gt;</span> #Type<span class="token punctuation">(</span>list <span class="token punctuation">(</span>pair address <span class="token punctuation">(</span>list <span class="token punctuation">(</span>pair address <span class="token punctuation">(</span>pair nat nat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>simplification<span class="token punctuation">]</span>

  <span class="token keyword">syntax</span> Data <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #TokenTransferData<span class="token punctuation">(</span><span class="token keyword">Bool</span><span class="token punctuation">,</span> Address<span class="token punctuation">,</span> Address<span class="token punctuation">,</span> <span class="token keyword">Int</span><span class="token punctuation">,</span> <span class="token keyword">Int</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">,</span> functional<span class="token punctuation">]</span>
 <span class="token comment">// -----------------------------------------------------------------------------------------</span>
  <span class="token keyword">rule</span> #TokenTransferData<span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> From<span class="token punctuation">,</span> To<span class="token punctuation">,</span> _TokenID<span class="token punctuation">,</span> TokenAmt<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>    Pair From     Pair To              TokenAmt                                          <span class="token punctuation">[</span>simplification<span class="token punctuation">]</span>
  <span class="token keyword">rule</span> #TokenTransferData<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>  From<span class="token punctuation">,</span> To<span class="token punctuation">,</span>  TokenID<span class="token punctuation">,</span> TokenAmt<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token operator">|</span> Pair From <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">|</span> Pair To Pair TokenID TokenAmt <span class="token operator">|</span><span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token punctuation">.</span>InternalList<span class="token punctuation">)</span> <span class="token operator">|</span><span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token punctuation">.</span>InternalList <span class="token punctuation">[</span>simplification<span class="token punctuation">]</span>

  <span class="token keyword">syntax</span> Entrypoint <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #TokenBalanceEntrypoint<span class="token punctuation">(</span>Address<span class="token punctuation">,</span> <span class="token keyword">Bool</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">,</span> functional<span class="token punctuation">]</span>
 <span class="token comment">// ---------------------------------------------------------------------------------</span>
  <span class="token keyword">rule</span> #TokenBalanceEntrypoint<span class="token punctuation">(</span>TokenAddr<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> TokenAddr <span class="token punctuation">.</span> <span class="token operator">%</span>getBalance
  <span class="token keyword">rule</span> #TokenBalanceEntrypoint<span class="token punctuation">(</span>TokenAddr<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> TokenAddr <span class="token punctuation">.</span> <span class="token operator">%</span>balance_of

  <span class="token keyword">syntax</span> Type <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #TokenBalanceEntrypointType<span class="token punctuation">(</span><span class="token keyword">Bool</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">,</span> functional<span class="token punctuation">]</span>
 <span class="token comment">// ----------------------------------------------------------------------</span>
  <span class="token keyword">rule</span> #TokenBalanceEntrypointType<span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> #Type<span class="token punctuation">(</span>pair address <span class="token punctuation">(</span>contract nat<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">rule</span> #TokenBalanceEntrypointType<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>  <span class="token operator">=&gt;</span> #Type<span class="token punctuation">(</span>pair <span class="token punctuation">(</span>list <span class="token punctuation">(</span>pair address nat<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>contract <span class="token punctuation">(</span>list <span class="token punctuation">(</span>pair <span class="token punctuation">(</span>pair <span class="token punctuation">(</span>address<span class="token punctuation">)</span> nat<span class="token punctuation">)</span> nat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">syntax</span> <span class="token keyword">Int</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #ceildiv   <span class="token punctuation">(</span><span class="token keyword">Int</span><span class="token punctuation">,</span> <span class="token keyword">Int</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
               <span class="token operator">|</span> #ceildivAux<span class="token punctuation">(</span><span class="token keyword">Int</span><span class="token punctuation">,</span> <span class="token keyword">Int</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">,</span> functional<span class="token punctuation">]</span>
 <span class="token comment">// ---------------------------------------------------------</span>
  <span class="token keyword">rule</span> #ceildiv   <span class="token punctuation">(</span>X<span class="token punctuation">,</span> Y<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> #ceildivAux<span class="token punctuation">(</span>X<span class="token punctuation">,</span> Y<span class="token punctuation">)</span> <span class="token keyword">requires</span> Y <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span><span class="token keyword">Int</span> <span class="token number">0</span>
  <span class="token keyword">rule</span> #ceildivAux<span class="token punctuation">(</span>_<span class="token punctuation">,</span> Y<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token number">0</span>                 <span class="token keyword">requires</span> Y  <span class="token operator">==</span><span class="token keyword">Int</span> <span class="token number">0</span>
  <span class="token keyword">rule</span> #ceildivAux<span class="token punctuation">(</span>X<span class="token punctuation">,</span> Y<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> X <span class="token operator">/</span><span class="token keyword">Int</span> Y          <span class="token keyword">requires</span> Y  <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span><span class="token keyword">Int</span> <span class="token number">0</span> andBool         X <span class="token operator">%</span><span class="token keyword">Int</span> Y <span class="token operator">==</span><span class="token keyword">Int</span> <span class="token number">0</span>
  <span class="token keyword">rule</span> #ceildivAux<span class="token punctuation">(</span>X<span class="token punctuation">,</span> Y<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> X <span class="token operator">/</span><span class="token keyword">Int</span> Y <span class="token operator">+</span><span class="token keyword">Int</span> <span class="token number">1</span>   <span class="token keyword">requires</span> Y  <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span><span class="token keyword">Int</span> <span class="token number">0</span> andBool notBool X <span class="token operator">%</span><span class="token keyword">Int</span> Y <span class="token operator">==</span><span class="token keyword">Int</span> <span class="token number">0</span>

  <span class="token keyword">syntax</span> <span class="token keyword">Int</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #CurrencyBought<span class="token punctuation">(</span><span class="token keyword">Int</span><span class="token punctuation">,</span> <span class="token keyword">Int</span><span class="token punctuation">,</span> <span class="token keyword">Int</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">,</span> functional<span class="token punctuation">,</span> smtlib<span class="token punctuation">(</span>xtzbought<span class="token punctuation">)</span><span class="token punctuation">,</span> no<span class="token operator">-</span>evaluators<span class="token punctuation">]</span>
 <span class="token comment">// ----------------------------------------------------------------------------------------------------</span>
  <span class="token keyword">rule</span> <span class="token punctuation">(</span>ToSellAmt <span class="token operator">*</span><span class="token keyword">Int</span> <span class="token number">997</span> <span class="token operator">*</span><span class="token keyword">Int</span> ToBuyCurrencyTotal<span class="token punctuation">)</span> <span class="token operator">/</span><span class="token keyword">Int</span> <span class="token punctuation">(</span>ToSellCurrencyTotal <span class="token operator">*</span><span class="token keyword">Int</span> <span class="token number">1000</span> <span class="token operator">+</span><span class="token keyword">Int</span> <span class="token punctuation">(</span>ToSellAmt <span class="token operator">*</span><span class="token keyword">Int</span> <span class="token number">997</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> #CurrencyBought<span class="token punctuation">(</span>ToBuyCurrencyTotal<span class="token punctuation">,</span> ToSellCurrencyTotal<span class="token punctuation">,</span> ToSellAmt<span class="token punctuation">)</span>
    <span class="token punctuation">[</span>simplification<span class="token punctuation">]</span>
</code></pre>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> <span class="token keyword">Bool</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #EntrypointExists<span class="token punctuation">(</span>Map<span class="token punctuation">,</span> Address<span class="token punctuation">,</span> FieldAnnotation<span class="token punctuation">,</span> Type<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token class-name">macro</span><span class="token punctuation">]</span>
<span class="token comment">// -----------------------------------------------------------------------------</span>
  <span class="token keyword">rule</span> #EntrypointExists<span class="token punctuation">(</span>KnownAddresses<span class="token punctuation">,</span> Addr<span class="token punctuation">,</span> FieldAnnot<span class="token punctuation">,</span> EntrypointType<span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> Addr <span class="token punctuation">.</span> FieldAnnot  in_keys<span class="token punctuation">(</span>KnownAddresses<span class="token punctuation">)</span> andBool
       KnownAddresses<span class="token punctuation">[</span>Addr <span class="token punctuation">.</span> FieldAnnot<span class="token punctuation">]</span> <span class="token operator">==</span>K #Name<span class="token punctuation">(</span>EntrypointType<span class="token punctuation">)</span>

  <span class="token keyword">syntax</span> <span class="token keyword">Bool</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #LocalEntrypointExists<span class="token punctuation">(</span>Map<span class="token punctuation">,</span> FieldAnnotation<span class="token punctuation">,</span> Type<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token class-name">macro</span><span class="token punctuation">]</span>
 <span class="token comment">// ------------------------------------------------------------------------</span>
  <span class="token keyword">rule</span> #LocalEntrypointExists<span class="token punctuation">(</span>LocalEntrypoints<span class="token punctuation">,</span> FieldAnnot<span class="token punctuation">,</span> EntrypointType<span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> FieldAnnot in_keys<span class="token punctuation">(</span>LocalEntrypoints<span class="token punctuation">)</span> andBool
       LocalEntrypoints<span class="token punctuation">[</span>FieldAnnot<span class="token punctuation">]</span> <span class="token operator">==</span>K #Name<span class="token punctuation">(</span>EntrypointType<span class="token punctuation">)</span>
</code></pre>
<h3 id="avoiding-interpreting-functions">Avoiding Interpreting Functions</h3>
<p>If a function value does not play well with the prover or SMT solver, it can be rewritten to <code>#uninterpreted</code>.
This function has no evaluation rules, so the prover can make no assumptions about it -- it will be assumed it can take on any value.</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> <span class="token keyword">Int</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #mulMod<span class="token punctuation">(</span><span class="token keyword">Int</span><span class="token punctuation">,</span> <span class="token keyword">Int</span><span class="token punctuation">,</span> <span class="token keyword">Int</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">,</span> functional<span class="token punctuation">,</span> smtlib<span class="token punctuation">(</span>mulMod<span class="token punctuation">)</span><span class="token punctuation">,</span> no<span class="token operator">-</span>evaluators<span class="token punctuation">]</span>
               <span class="token operator">|</span> #mulDiv<span class="token punctuation">(</span><span class="token keyword">Int</span><span class="token punctuation">,</span> <span class="token keyword">Int</span><span class="token punctuation">,</span> <span class="token keyword">Int</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">,</span> functional<span class="token punctuation">,</span> smtlib<span class="token punctuation">(</span>mulDiv<span class="token punctuation">)</span><span class="token punctuation">,</span> no<span class="token operator">-</span>evaluators<span class="token punctuation">]</span>
 <span class="token comment">// -----------------------------------------------------------------------------------------</span>
  <span class="token keyword">rule</span> <span class="token punctuation">(</span>X <span class="token operator">*</span><span class="token keyword">Int</span> Y<span class="token punctuation">)</span> <span class="token operator">%</span><span class="token keyword">Int</span> Z <span class="token operator">=&gt;</span> #mulMod<span class="token punctuation">(</span>X<span class="token punctuation">,</span> Y<span class="token punctuation">,</span> Z<span class="token punctuation">)</span> <span class="token punctuation">[</span>simplification<span class="token punctuation">]</span>
  <span class="token keyword">rule</span> <span class="token punctuation">(</span>X <span class="token operator">*</span><span class="token keyword">Int</span> Y<span class="token punctuation">)</span> <span class="token operator">/</span><span class="token keyword">Int</span> Z <span class="token operator">=&gt;</span> #mulDiv<span class="token punctuation">(</span>X<span class="token punctuation">,</span> Y<span class="token punctuation">,</span> Z<span class="token punctuation">)</span> <span class="token punctuation">[</span>simplification<span class="token punctuation">]</span>
</code></pre>
<h2 id="putting-it-all-together">Putting It All Together</h2>
<p>All contract call specifications have common steps:</p>
<ol>
<li>Load parameters and storage onto the stack.</li>
<li>Execute the Dexter contract code.</li>
<li>Save the resulting storage.</li>
</ol>
<p>If all steps are completed, only the Dexter-specific storage is updated.</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #runProof<span class="token punctuation">(</span><span class="token keyword">Bool</span><span class="token punctuation">,</span> EntryPointParams<span class="token punctuation">)</span>
 <span class="token comment">// ------------------------------------------------</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #runProof<span class="token punctuation">(</span>IsFA2<span class="token punctuation">,</span> Params<span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> #loadDexterState<span class="token punctuation">(</span>IsFA2<span class="token punctuation">,</span> Params<span class="token punctuation">)</span>
        <span class="token operator">~&gt;</span> #dexterCode<span class="token punctuation">(</span>IsFA2<span class="token punctuation">)</span>
        <span class="token operator">~&gt;</span> #storeDexterState<span class="token punctuation">(</span>IsFA2<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>myamount</span><span class="token punctuation">&gt;</span></span> #Mutez<span class="token punctuation">(</span>Amount<span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>myamount</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xtzPool</span><span class="token punctuation">&gt;</span></span> #Mutez<span class="token punctuation">(</span>XtzPool<span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xtzPool</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tokenPool</span><span class="token punctuation">&gt;</span></span> TokenPool <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tokenPool</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>operations</span><span class="token punctuation">&gt;</span></span> OpList <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>operations</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>returncode</span><span class="token punctuation">&gt;</span></span> ReturnCode <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>returncode</span><span class="token punctuation">&gt;</span></span>
    ensures wellTypedParams<span class="token punctuation">(</span>IsFA2<span class="token punctuation">,</span> Params<span class="token punctuation">)</span>
    andBool #IsLegalMutezValue<span class="token punctuation">(</span>Amount<span class="token punctuation">)</span>
    andBool #IsLegalMutezValue<span class="token punctuation">(</span>XtzPool<span class="token punctuation">)</span>
    andBool TokenPool <span class="token operator">&gt;=</span><span class="token keyword">Int</span> <span class="token number">0</span>
    andBool OpList <span class="token operator">==</span>K <span class="token punctuation">.</span>InternalList
    andBool ReturnCode <span class="token operator">==</span><span class="token keyword">Int</span> <span class="token number">111</span>
</code></pre>
<h2 id="epilogue">Epilogue</h2>
<p>We close out our module context now, which contains all of the information necessary to complete our proof.</p>
<pre class="language-k"><code><span class="token keyword">endmodule</span>
</code></pre>
</body></html></div>
        </main>

        <!-- Page ToC -->
        <div class="col-12 col-md-3 col-xl-2 py-md-3 bd-sidebar page-toc mb-3">
          
<div>
<details style="padding:0.25rem 0;;padding-left: 0px;" open>
            <summary class="bd-toc-link-wrapper">
              <a href="#dexter-verification" class="bd-toc-link">Dexter Verification</a>
              </summary>
            <div>
              <div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#prologue"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Prologue
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#dexter-lemmas"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Dexter Lemmas
              </a></div><details style="padding:0.25rem 0;;padding-left: 8px;" open>
            <summary class="bd-toc-link-wrapper">
              <a href="#terminology-prerequisites" class="bd-toc-link">Terminology Prerequisites</a>
              </summary>
            <div>
              <div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#entrypoints"
                class="bd-toc-link"
                style="padding-left: 16px;;"
              >
                Entrypoints
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#storage-type"
                class="bd-toc-link"
                style="padding-left: 16px;;"
              >
                Storage Type
              </a></div>
            </div>
          </details>
        <div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#entrypoint-summaries"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Entrypoint Summaries
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#state-abstraction"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                State Abstraction
              </a></div><details style="padding:0.25rem 0;;padding-left: 8px;" open>
            <summary class="bd-toc-link-wrapper">
              <a href="#proof-helper-functions" class="bd-toc-link">Proof Helper Functions</a>
              </summary>
            <div>
              <div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#avoiding-interpreting-functions"
                class="bd-toc-link"
                style="padding-left: 16px;;"
              >
                Avoiding Interpreting Functions
              </a></div>
            </div>
          </details>
        <div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#putting-it-all-together"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Putting It All Together
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#epilogue"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Epilogue
              </a></div>
            </div>
          </details>
        
</div>

        </div>
        <div class="btn btn-rv-blue page-toc-toggle-btn"></div>
        <!-- End Page ToC -->
      </div>
    </div>
<!-- The footer is now controlled by the k-web-theme git submodule -->
<footer id="rvsite-footer" class="app-footer text-md-left text-center">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-4 mb-md-0 mb-4">
        <a href="https://runtimeverification.com/" target="_blank">
          <picture>
            <source
              srcset="
                https://runtimeverification.com/assets/img/rv-logo-dark.png
              "
              media="(prefers-color-scheme: dark)"
            />
            <img
              class="logo-dark"
              src="https://runtimeverification.com/assets/img/rv-logo.png"
              alt="Runtime Verification logo"
              style="height: 32px"
            /> </picture
        ></a>
        <p class="mt-2 text-md-left copyright">
          <a href="https://goo.gl/maps/hKLtCjeEd6yqfzwx5" target="_blank"
            >1807 S Neil Street, Champaign, IL 61820</a
          >
        </p>
      </div>
      <div class="col-md-4 text-md-center mb-md-0 mb-4"></div>
      <div class="col-md-4 mb-md-0 mb-4 text-md-right">
        <p class="copyright">2022 © all rights reserved</p>
      </div>
    </div>
  </div>
</footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Typist/1.2/typist.min.js"></script>
    <script src="../../../../assets/js/index.js"></script>
  </body>
</html>
