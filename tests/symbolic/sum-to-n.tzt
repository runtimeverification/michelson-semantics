code { PAIR ;
       LEFT nat ;
       LOOP_LEFT @I { UNPAIR ;
                      DUP ;
                      DIP { ADD } ;
                      PUSH nat 1 ;
                      SWAP ;
                      SUB ;
                      ISNAT ;
                      IF_NONE { RIGHT (pair nat nat) } { PAIR ; LEFT nat } } } ;
input { Stack_elt nat $I1 ; Stack_elt nat $I2 } ;
output { Stack_elt nat $I3 } ;
// TODO: fix typing issue
invariant @I { Stack_elt (or (pair nat nat) nat) $LC }
{ { PUSH (or (pair nat nat) nat) $LC ;
    IF_LEFT { UNPAIR ;
              DIP { DUP ;
                    PUSH nat 1 ;
                    ADD ;
                    MUL ;
                    PUSH nat 2 ;
                    EDIV ;
                    IF_NONE { UNIT ; FAILWITH } { }
              } ;
              ADD ;
              PUSH nat $I2 ;
              PUSH nat $I1 ;
              DIP { DUP ;
                    PUSH nat 1 ;
                    ADD ;
                    MUL ;
                    PUSH nat 2 ;
                    EDIV ;
                    IF_NONE { UNIT ; FAILWITH } {  }
              }
    } { }
} } ;
postcondition {
  { PUSH nat $I1 ;
    DUP ;
    PUSH nat 1 ;
    ADD ;
    MUL ;
    PUSH nat 2 ;
    EDIV ;
    IF_NONE { UNIT ; FAILWITH } { } ;
    PUSH nat $I2 ;
    ADD ;
    PUSH nat $I3 ;
    COMPARE ;
    EQ
  }
}
